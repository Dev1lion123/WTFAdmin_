{"ast":null,"code":"var Sequence = require('./Sequence');\nvar Util = require('util');\nvar Packets = require('../packets');\nvar Auth = require('../Auth');\nvar ClientConstants = require('../constants/client');\nmodule.exports = Handshake;\nUtil.inherits(Handshake, Sequence);\nfunction Handshake(options, callback) {\n  Sequence.call(this, options, callback);\n  options = options || {};\n  this._config = options.config;\n  this._handshakeInitializationPacket = null;\n}\nHandshake.prototype.determinePacket = function determinePacket(firstByte, parser) {\n  if (firstByte === 0xff) {\n    return Packets.ErrorPacket;\n  }\n  if (!this._handshakeInitializationPacket) {\n    return Packets.HandshakeInitializationPacket;\n  }\n  if (firstByte === 0xfe) {\n    return parser.packetLength() === 1 ? Packets.UseOldPasswordPacket : Packets.AuthSwitchRequestPacket;\n  }\n  return undefined;\n};\nHandshake.prototype['AuthSwitchRequestPacket'] = function (packet) {\n  var name = packet.authMethodName;\n  var data = Auth.auth(name, packet.authMethodData, {\n    password: this._config.password\n  });\n  if (data !== undefined) {\n    this.emit('packet', new Packets.AuthSwitchResponsePacket({\n      data: data\n    }));\n  } else {\n    var err = new Error('MySQL is requesting the ' + name + ' authentication method, which is not supported.');\n    err.code = 'UNSUPPORTED_AUTH_METHOD';\n    err.fatal = true;\n    this.end(err);\n  }\n};\nHandshake.prototype['HandshakeInitializationPacket'] = function (packet) {\n  this._handshakeInitializationPacket = packet;\n  this._config.protocol41 = packet.protocol41;\n  var serverSSLSupport = packet.serverCapabilities1 & ClientConstants.CLIENT_SSL;\n  if (this._config.ssl) {\n    if (!serverSSLSupport) {\n      var err = new Error('Server does not support secure connection');\n      err.code = 'HANDSHAKE_NO_SSL_SUPPORT';\n      err.fatal = true;\n      this.end(err);\n      return;\n    }\n    this._config.clientFlags |= ClientConstants.CLIENT_SSL;\n    this.emit('packet', new Packets.SSLRequestPacket({\n      clientFlags: this._config.clientFlags,\n      maxPacketSize: this._config.maxPacketSize,\n      charsetNumber: this._config.charsetNumber\n    }));\n    this.emit('start-tls');\n  } else {\n    this._sendCredentials();\n  }\n};\nHandshake.prototype._tlsUpgradeCompleteHandler = function () {\n  this._sendCredentials();\n};\nHandshake.prototype._sendCredentials = function () {\n  var packet = this._handshakeInitializationPacket;\n  this.emit('packet', new Packets.ClientAuthenticationPacket({\n    clientFlags: this._config.clientFlags,\n    maxPacketSize: this._config.maxPacketSize,\n    charsetNumber: this._config.charsetNumber,\n    user: this._config.user,\n    database: this._config.database,\n    protocol41: packet.protocol41,\n    scrambleBuff: packet.protocol41 ? Auth.token(this._config.password, packet.scrambleBuff()) : Auth.scramble323(packet.scrambleBuff(), this._config.password)\n  }));\n};\nHandshake.prototype['UseOldPasswordPacket'] = function () {\n  if (!this._config.insecureAuth) {\n    var err = new Error('MySQL server is requesting the old and insecure pre-4.1 auth mechanism. ' + 'Upgrade the user password or use the {insecureAuth: true} option.');\n    err.code = 'HANDSHAKE_INSECURE_AUTH';\n    err.fatal = true;\n    this.end(err);\n    return;\n  }\n  this.emit('packet', new Packets.OldPasswordPacket({\n    scrambleBuff: Auth.scramble323(this._handshakeInitializationPacket.scrambleBuff(), this._config.password)\n  }));\n};\nHandshake.prototype['ErrorPacket'] = function (packet) {\n  var err = this._packetToError(packet, true);\n  err.fatal = true;\n  this.end(err);\n};","map":{"version":3,"names":["Sequence","require","Util","Packets","Auth","ClientConstants","module","exports","Handshake","inherits","options","callback","call","_config","config","_handshakeInitializationPacket","prototype","determinePacket","firstByte","parser","ErrorPacket","HandshakeInitializationPacket","packetLength","UseOldPasswordPacket","AuthSwitchRequestPacket","undefined","packet","name","authMethodName","data","auth","authMethodData","password","emit","AuthSwitchResponsePacket","err","Error","code","fatal","end","protocol41","serverSSLSupport","serverCapabilities1","CLIENT_SSL","ssl","clientFlags","SSLRequestPacket","maxPacketSize","charsetNumber","_sendCredentials","_tlsUpgradeCompleteHandler","ClientAuthenticationPacket","user","database","scrambleBuff","token","scramble323","insecureAuth","OldPasswordPacket","_packetToError"],"sources":["G:/GH projects/WTFAdmin/node_modules/mysql/lib/protocol/sequences/Handshake.js"],"sourcesContent":["var Sequence        = require('./Sequence');\r\nvar Util            = require('util');\r\nvar Packets         = require('../packets');\r\nvar Auth            = require('../Auth');\r\nvar ClientConstants = require('../constants/client');\r\n\r\nmodule.exports = Handshake;\r\nUtil.inherits(Handshake, Sequence);\r\nfunction Handshake(options, callback) {\r\n  Sequence.call(this, options, callback);\r\n\r\n  options = options || {};\r\n\r\n  this._config                        = options.config;\r\n  this._handshakeInitializationPacket = null;\r\n}\r\n\r\nHandshake.prototype.determinePacket = function determinePacket(firstByte, parser) {\r\n  if (firstByte === 0xff) {\r\n    return Packets.ErrorPacket;\r\n  }\r\n\r\n  if (!this._handshakeInitializationPacket) {\r\n    return Packets.HandshakeInitializationPacket;\r\n  }\r\n\r\n  if (firstByte === 0xfe) {\r\n    return (parser.packetLength() === 1)\r\n      ? Packets.UseOldPasswordPacket\r\n      : Packets.AuthSwitchRequestPacket;\r\n  }\r\n\r\n  return undefined;\r\n};\r\n\r\nHandshake.prototype['AuthSwitchRequestPacket'] = function (packet) {\r\n  var name = packet.authMethodName;\r\n  var data = Auth.auth(name, packet.authMethodData, {\r\n    password: this._config.password\r\n  });\r\n\r\n  if (data !== undefined) {\r\n    this.emit('packet', new Packets.AuthSwitchResponsePacket({\r\n      data: data\r\n    }));\r\n  } else {\r\n    var err   = new Error('MySQL is requesting the ' + name + ' authentication method, which is not supported.');\r\n    err.code  = 'UNSUPPORTED_AUTH_METHOD';\r\n    err.fatal = true;\r\n    this.end(err);\r\n  }\r\n};\r\n\r\nHandshake.prototype['HandshakeInitializationPacket'] = function(packet) {\r\n  this._handshakeInitializationPacket = packet;\r\n\r\n  this._config.protocol41 = packet.protocol41;\r\n\r\n  var serverSSLSupport = packet.serverCapabilities1 & ClientConstants.CLIENT_SSL;\r\n\r\n  if (this._config.ssl) {\r\n    if (!serverSSLSupport) {\r\n      var err = new Error('Server does not support secure connection');\r\n\r\n      err.code = 'HANDSHAKE_NO_SSL_SUPPORT';\r\n      err.fatal = true;\r\n\r\n      this.end(err);\r\n      return;\r\n    }\r\n\r\n    this._config.clientFlags |= ClientConstants.CLIENT_SSL;\r\n    this.emit('packet', new Packets.SSLRequestPacket({\r\n      clientFlags   : this._config.clientFlags,\r\n      maxPacketSize : this._config.maxPacketSize,\r\n      charsetNumber : this._config.charsetNumber\r\n    }));\r\n    this.emit('start-tls');\r\n  } else {\r\n    this._sendCredentials();\r\n  }\r\n};\r\n\r\nHandshake.prototype._tlsUpgradeCompleteHandler = function() {\r\n  this._sendCredentials();\r\n};\r\n\r\nHandshake.prototype._sendCredentials = function() {\r\n  var packet = this._handshakeInitializationPacket;\r\n  this.emit('packet', new Packets.ClientAuthenticationPacket({\r\n    clientFlags   : this._config.clientFlags,\r\n    maxPacketSize : this._config.maxPacketSize,\r\n    charsetNumber : this._config.charsetNumber,\r\n    user          : this._config.user,\r\n    database      : this._config.database,\r\n    protocol41    : packet.protocol41,\r\n    scrambleBuff  : (packet.protocol41)\r\n      ? Auth.token(this._config.password, packet.scrambleBuff())\r\n      : Auth.scramble323(packet.scrambleBuff(), this._config.password)\r\n  }));\r\n};\r\n\r\nHandshake.prototype['UseOldPasswordPacket'] = function() {\r\n  if (!this._config.insecureAuth) {\r\n    var err = new Error(\r\n      'MySQL server is requesting the old and insecure pre-4.1 auth mechanism. ' +\r\n      'Upgrade the user password or use the {insecureAuth: true} option.'\r\n    );\r\n\r\n    err.code = 'HANDSHAKE_INSECURE_AUTH';\r\n    err.fatal = true;\r\n\r\n    this.end(err);\r\n    return;\r\n  }\r\n\r\n  this.emit('packet', new Packets.OldPasswordPacket({\r\n    scrambleBuff: Auth.scramble323(this._handshakeInitializationPacket.scrambleBuff(), this._config.password)\r\n  }));\r\n};\r\n\r\nHandshake.prototype['ErrorPacket'] = function(packet) {\r\n  var err = this._packetToError(packet, true);\r\n  err.fatal = true;\r\n  this.end(err);\r\n};\r\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}